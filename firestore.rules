rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Rules for uploaded_files collection
    match /uploaded_files/{fileId} {
      // Allow users to read their own files
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Allow users to create files with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['fileName', 'fileSize', 'fileType', 'user_id', 'userPlan', 'uploadedAt', 'fileSizeMB']);
      
      // Allow users to update their own files
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid;
      
      // Allow users to delete their own files
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Rules for chat_messages collection
    match /chat_messages/{messageId} {
      // Allow users to read their own messages
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Allow users to create messages with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'role', 'content', 'timestamp']) &&
                       request.resource.data.role in ['user', 'assistant'];
      
      // Allow users to update their own messages (optional - can be removed if not needed)
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid;
      
      // Allow users to delete their own messages
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Rules for quizzes collection
    match /quizzes/{quizId} {
      // Allow users to read their own quizzes
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Allow users to create quizzes with their own user_id
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid &&
                       request.resource.data.keys().hasAll(['user_id', 'title', 'questions', 'createdAt', 'userPlan']);
      
      // Allow users to update their own quizzes
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid &&
                       request.resource.data.user_id == request.auth.uid;
      
      // Allow users to delete their own quizzes
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Rules for user_usage collection (usage tracking)
    match /user_usage/{usageId} {
      // Allow users to read their own usage data
      allow read: if isAuthenticated() && 
                     resource.data.user_id == request.auth.uid;
      
      // Allow users to create their own usage tracking
      allow create: if isAuthenticated() && 
                       request.resource.data.user_id == request.auth.uid;
      
      // Allow users to update their own usage data
      allow update: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
      
      // Allow users to delete their own usage data
      allow delete: if isAuthenticated() && 
                       resource.data.user_id == request.auth.uid;
    }
    
    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

